steps:
- bash: |
    echo "Building baremetal helloworld for ${MACHINE}"
    cd ~/poky
    source oe-init-build-env
    mkdir -p ./conf/multiconfig
    echo "BUILDCFG_VARS_append = \" TCLIBC\"" >> ./conf/local.conf
    echo "BBMULTICONFIG = \"bare\"" >> ./conf/local.conf
    echo "MACHINE = \"${MACHINE}\"" >> ./conf/local.conf
    echo "TCLIBC = \"newlib\"" >> ./conf/local.conf
    echo "MACHINE = \"${MACHINE}\"" >> ./conf/multiconfig/bare.conf
    echo "TCLIBC = \"baremetal\"" >> ./conf/multiconfig/bare.conf
    echo "TMPDIR = \"\${TOPDIR}/tmp-${MACHINE}-baremetal\"" >> ./conf/multiconfig/bare.conf
    echo "Building with the following configuration:"
    tail -n 10 conf/local.conf
    # mkdir ~/poky/meta/recipes-devtools/qemu
    echo "do_build[mcdepends] = \"multiconfig:bare::qemu-native:build\"" >> ~/poky/meta/recipes-devtools/qemu/qemu-native_%.bbappend
    echo "do_build[mcdepends] = \"multiconfig:bare::qemu-system-native:do_build\"" >> ~/poky/meta/recipes-devtools/qemu/qemu-system-native_%.bbappend
    bitbake mc::baremetal-helloworld
    bitbake mc:bare:baremetal-helloworld
    # if [ -e ~/poky/build/tmp/work/x86_64-linux/qemu-native/6.0.0-r0/temp/log.do_populate_sysroot_setscene ]; then
    #     echo "File found in tmp"
    #     ls -l ~/sstate-cache/universal/d1/69/sstate:qemu-native:x86_64-linux:6.0.0:r0:x86_64:3:d169e19ab5c1d5c97951a84294e6cc7e11154576f5256b5cc0a1ce87ed425ddc_populate_sysroot.tgz
    #     echo "md5sum"
    #     md5sum ~/sstate-cache/universal/d1/69/sstate:qemu-native:x86_64-linux:6.0.0:r0:x86_64:3:d169e19ab5c1d5c97951a84294e6cc7e11154576f5256b5cc0a1ce87ed425ddc_populate_sysroot.tgz
    #     cat ~/poky/build/tmp/work/x86_64-linux/qemu-native/6.0.0-r0/temp/log.do_populate_sysroot_setscene
    # fi
    # if [ -e ~/poky/build/tmp-${MACHINE}-baremetal/work/x86_64-linux/qemu-native/6.0.0-r0/temp/log.do_populate_sysroot_setscene ]; then
    #     echo "File found in tmp-qemu"
    #     ls -l ~/sstate-cache/universal/d1/69/sstate:qemu-native:x86_64-linux:6.0.0:r0:x86_64:3:d169e19ab5c1d5c97951a84294e6cc7e11154576f5256b5cc0a1ce87ed425ddc_populate_sysroot.tgz
    #     echo "md5sum"
    #     md5sum ~/sstate-cache/universal/d1/69/sstate:qemu-native:x86_64-linux:6.0.0:r0:x86_64:3:d169e19ab5c1d5c97951a84294e6cc7e11154576f5256b5cc0a1ce87ed425ddc_populate_sysroot.tgz
    #     cat ~/poky/build/tmp-${MACHINE}-baremetal/work/x86_64-linux/qemu-native/6.0.0-r0/temp/log.do_populate_sysroot_setscene
    # fi
  condition: succeededOrFailed()
  displayName: 'Build baremetal images'

- bash: |
    source azp-scripts/azp-helpers.sh
    check_freespace
    SASW_TOKEN="$(SASW_TOKEN)" sync_sstate
  condition: succeededOrFailed()
  displayName: 'Sync sstate'

- bash: |
    source azp-scripts/azp-helpers.sh
    echo "Moving artifacts to be deployed"
    rm -rf ${DEPLOY_ARTIFACTS_DIR}/*
    # Newlib artifacts
    # BIN
    mv /home/vsts/poky/build/tmp/deploy/images/${MACHINE}/baremetal-helloworld-*.bin ${DEPLOY_ARTIFACTS_DIR}
    # ELF
    mv /home/vsts/poky/build/tmp/deploy/images/${MACHINE}/baremetal-helloworld-*.elf ${DEPLOY_ARTIFACTS_DIR}
    # QEMUboot
    mv /home/vsts/poky/build/tmp/deploy/images/${MACHINE}/baremetal-helloworld-*.qemuboot.conf ${DEPLOY_ARTIFACTS_DIR}
    # Manifest
    mv /home/vsts/poky/build/tmp/deploy/images/${MACHINE}/baremetal-helloworld-*.manifest ${DEPLOY_ARTIFACTS_DIR}

    # Baremetal artifacts
    # BIN
    mv /home/vsts/poky/build/tmp-${MACHINE}-baremetal/deploy/images/${MACHINE}/baremetal-helloworld-*.bin ${DEPLOY_ARTIFACTS_DIR}
    # ELF
    mv /home/vsts/poky/build/tmp-${MACHINE}-baremetal/deploy/images/${MACHINE}/baremetal-helloworld-*.elf ${DEPLOY_ARTIFACTS_DIR}
    # QEMUboot
    mv /home/vsts/poky/build/tmp-${MACHINE}-baremetal/deploy/images/${MACHINE}/baremetal-helloworld-*.qemuboot.conf ${DEPLOY_ARTIFACTS_DIR}
    # Manifest
    mv /home/vsts/poky/build/tmp-${MACHINE}-baremetal/deploy/images/${MACHINE}/baremetal-helloworld-*.manifest ${DEPLOY_ARTIFACTS_DIR}
  condition: succeededOrFailed()
  displayName: 'Moving Artifacts'

- publish: $(DEPLOY_ARTIFACTS_DIR)
  artifact: $(MACHINE)
  condition: succeededOrFailed()
